cmake_minimum_required(VERSION 3.5)
project(SecureVision LANGUAGES CXX)

# 1. äº¤å‰ç¼–è¯‘å·¥å…·é“¾è®¾ç½®ï¼ˆå¿…é¡»æœ€å…ˆè®¾ç½®ï¼‰
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR arm)

# å·¥å…·é“¾è·¯å¾„ï¼ˆæ ¹æ®æ‚¨çš„å®é™…è·¯å¾„è°ƒæ•´ï¼‰
set(TOOLCHAIN_DIR /opt/atk-dlrv1126-toolchain)
set(CMAKE_C_COMPILER ${TOOLCHAIN_DIR}/usr/bin/arm-linux-gnueabihf-gcc)
set(CMAKE_CXX_COMPILER ${TOOLCHAIN_DIR}/usr/bin/arm-linux-gnueabihf-g++)

# 2. ç³»ç»Ÿæ ¹ç›®å½•è®¾ç½®ï¼ˆå…³é”®ä¿®æ­£ï¼‰
# æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ buildroot è¾“å‡ºçš„ host ç›®å½•ä¸‹çš„ sysroot
set(SYSROOT_PATH ${TOOLCHAIN_DIR}/arm-buildroot-linux-gnueabihf/sysroot)
set(CMAKE_FIND_ROOT_PATH ${SYSROOT_PATH})
set(CMAKE_SYSROOT ${SYSROOT_PATH})

# 3. æœç´¢è§„åˆ™è®¾ç½®
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)

# 4. åŸºç¡€ç¼–è¯‘è®¾ç½®
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# 5. FFmpeg è·¯å¾„è®¾ç½®ï¼ˆä½¿ç”¨æ‚¨æ‰¾åˆ°çš„å®é™…è·¯å¾„ï¼‰
set(FFMPEG_INCLUDE_DIRS
    ${SYSROOT_PATH}/usr/include
    /home/zhenglongbin/code/rv1126/buildroot/output/alientek_rv1126/build/ffmpeg-4.1.3
)

# 6. OpenCV é…ç½® - ä¼˜åŒ–ç‰ˆæœ¬
# è®¾ç½® OpenCV æ ¹ç›®å½•
set(OpenCV_ROOT ${CMAKE_SOURCE_DIR}/buildroot/output/alientek_rv1126/build/opencv3-3.4.12/buildroot-build)

# è®¾ç½®åŒ…å«è·¯å¾„
set(OpenCV_INCLUDE_DIRS
    ${OpenCV_ROOT}/../include
    ${OpenCV_ROOT}/../include/opencv
    ${OpenCV_ROOT}/../include/opencv2
)

# è®¾ç½®åº“ç›®å½•
set(OpenCV_LIB_DIR ${OpenCV_ROOT}/lib)

# æ‰‹åŠ¨è®¾ç½® OpenCV åº“æ–‡ä»¶
set(OpenCV_LIBS
    opencv_core
    opencv_imgproc
    opencv_videoio
    opencv_highgui
)

# 7. RockX å’Œ RKNN åº“é…ç½®ï¼ˆæ–°å¢ï¼‰
set(ROCKX_INCLUDE_DIR ${SYSROOT_PATH}/usr/include)
set(ROCKX_LIB_DIR ${SYSROOT_PATH}/usr/lib)

# æŸ¥æ‰¾ RockX ç›¸å…³åº“
find_library(ROCKX_LIB
    NAMES rockx librockx
    PATHS ${ROCKX_LIB_DIR}
    PATH_SUFFIXES arm-linux-gnueabihf
    NO_DEFAULT_PATH
)

find_library(RKNN_API_LIB
    NAMES rknn_api librknn_api rknnrt librknnrt
    PATHS ${ROCKX_LIB_DIR}
    PATH_SUFFIXES arm-linux-gnueabihf
    NO_DEFAULT_PATH
)

# æŸ¥æ‰¾ SQLite3 åº“
find_library(SQLITE3_LIB
    NAMES sqlite3 libsqlite3
    PATHS ${ROCKX_LIB_DIR}
    PATH_SUFFIXES arm-linux-gnueabihf
    NO_DEFAULT_PATH
)

# éªŒè¯åº“æ–‡ä»¶
if(NOT ROCKX_LIB)
    message(WARNING "RockX library not found in ${ROCKX_LIB_DIR}")
    # åˆ—å‡ºå¯ç”¨çš„åº“æ–‡ä»¶è¿›è¡Œè°ƒè¯•
    file(GLOB AVAILABLE_LIBS "${ROCKX_LIB_DIR}/*rockx*" "${ROCKX_LIB_DIR}/*/*rockx*")
    message(STATUS "Available RockX related files: ${AVAILABLE_LIBS}")
endif()

if(NOT RKNN_API_LIB)
    message(WARNING "RKNN API library not found in ${ROCKX_LIB_DIR}")
    file(GLOB AVAILABLE_RKNN_LIBS "${ROCKX_LIB_DIR}/*rknn*" "${ROCKX_LIB_DIR}/*/*rknn*")
    message(STATUS "Available RKNN related files: ${AVAILABLE_RKNN_LIBS}")
endif()

if(NOT SQLITE3_LIB)
    message(WARNING "SQLite3 library not found in ${ROCKX_LIB_DIR}")
    file(GLOB AVAILABLE_SQLITE_LIBS "${ROCKX_LIB_DIR}/*sqlite*" "${ROCKX_LIB_DIR}/*/*sqlite*")
    message(STATUS "Available SQLite related files: ${AVAILABLE_SQLITE_LIBS}")
endif()

# 7. æŸ¥æ‰¾ Qt5 åº“ï¼ˆå¿…é¡»åœ¨è®¾ç½® SYSROOT åï¼‰
set(Qt5_DIR ${SYSROOT_PATH}/usr/lib/cmake/Qt5)  # æ ¹æ®å®é™…è·¯å¾„è°ƒæ•´
find_package(Qt5 REQUIRED COMPONENTS Core Gui Widgets Multimedia Network MultimediaWidgets PrintSupport Sql)

# 8. åŒ…å«ç›®å½•è®¾ç½®
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${FFMPEG_INCLUDE_DIRS}
    ${OpenCV_INCLUDE_DIRS}
    # RKMedia è·¯å¾„
    /home/zhenglongbin/code/rv1126/external/rkmedia/include
    /home/zhenglongbin/code/rv1126/app/alientek/atk_rkmedia/library/include
    ${Qt5Multimedia_INCLUDE_DIRS}

    #æ–°å¢ RockX ç›¸å…³è·¯å¾„
    ${ROCKX_INCLUDE_DIR}
    ${ROCKX_INCLUDE_DIR}/rockx
    ${ROCKX_INCLUDE_DIR}/rknn
)

if(Qt5_FOUND)
    # å°†QtåŒ…å«ç›®å½•æ·»åŠ åˆ°å…¨å±€åŒ…å«
    include_directories(${Qt5Core_INCLUDE_DIRS} ${Qt5Gui_INCLUDE_DIRS} ${Qt5Widgets_INCLUDE_DIRS} ${Qt5Network_INCLUDE_DIRS})

    # æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    message(STATUS "Qt5Core include dirs: ${Qt5Core_INCLUDE_DIRS}")
    message(STATUS "Qt5Gui include dirs: ${Qt5Gui_INCLUDE_DIRS}")
endif()

# 9. æ·»åŠ åº“æ–‡ä»¶æœç´¢è·¯å¾„
link_directories(
    ${OpenCV_LIB_DIR}
    # å…¶ä»–å¯èƒ½çš„åº“ç›®å½•...
)

# 10. æ·»åŠ å­ç›®å½•
add_subdirectory(ai)
add_subdirectory(widgets)
add_subdirectory(core)
add_subdirectory(ui)
add_subdirectory(capture)
add_subdirectory(main)

# add_subdirectory(record)

# 11. ä¸»ç¨‹åºé…ç½®
set(RESOURCE_FILE Resource/secureVision.qrc)

# ç”Ÿæˆèµ„æºæ–‡ä»¶ï¼ˆQt5 æ–¹å¼ï¼‰
qt5_add_resources(RESOURCE_FILES ${RESOURCE_FILE})

add_executable(SecureVision
    ${RESOURCE_FILES}
    # å…¶ä»–æºæ–‡ä»¶...
)

# 12. é“¾æ¥åº“é…ç½®
target_link_libraries(SecureVision PRIVATE
    capture
    widgets
    core
    ai
    ui
    main

    Qt5::Core
    Qt5::Gui
    Qt5::Widgets
    Qt5::Network
    Qt5::Multimedia
    Qt5::MultimediaWidgets
    Qt5::PrintSupport
    Qt5::Sql

    avformat
    avcodec
    avutil
    swscale

    easymedia
    third_media
    rockchip_mpp
    atk_camera
    sample_common_isp
    pthread

    ${OpenCV_LIBS}  # é“¾æ¥ OpenCV åº“
    ${ROCKX_LIB}
    ${RKNN_API_LIB}
    ${SQLITE3_LIB}
)

# 13. å®‰è£…è®¾ç½®
set_target_properties(SecureVision PROPERTIES
    INSTALL_RPATH "/oem/usr/lib"
    BUILD_WITH_INSTALL_RPATH TRUE
)

# 14. æ·»åŠ å®‰è£…è§„åˆ™ï¼ˆç§»é™¤é‡å¤ï¼‰
install(TARGETS SecureVision
    RUNTIME DESTINATION bin
)

# ğŸ†• 15. æ·»åŠ RockXæ¨¡å‹æ–‡ä»¶å®‰è£…è§„åˆ™ï¼ˆä»…å®‰è£…å¿…éœ€çš„3ä¸ªæ¨¡å‹ï¼‰
set(ROCKX_MODEL_SOURCE_DIR "${CMAKE_SOURCE_DIR}/data/models/rockx_data")

# å®šä¹‰äººè„¸è¯†åˆ«å¿…éœ€çš„æ¨¡å‹æ–‡ä»¶
set(REQUIRED_FACE_MODELS
    "face_detection_v3_fast.data"    # äººè„¸æ£€æµ‹
    "face_landmark5.data"            # 5ç‚¹å…³é”®ç‚¹æ£€æµ‹
    "face_recognition.data"          # äººè„¸è¯†åˆ«ç‰¹å¾æå–
)

# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶ç›®å½•æ˜¯å¦å­˜åœ¨
if(EXISTS ${ROCKX_MODEL_SOURCE_DIR})
    message(STATUS "Found RockX models directory: ${ROCKX_MODEL_SOURCE_DIR}")

    # åˆ—å‡ºæºç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
    file(GLOB ALL_MODEL_FILES "${ROCKX_MODEL_SOURCE_DIR}/*.data")
    message(STATUS "All available model files: ${ALL_MODEL_FILES}")

    # æ£€æŸ¥å¹¶å®‰è£…æ¯ä¸ªå¿…éœ€çš„æ¨¡å‹æ–‡ä»¶
    set(MODELS_TO_INSTALL "")
    foreach(MODEL_FILE ${REQUIRED_FACE_MODELS})
        set(FULL_MODEL_PATH "${ROCKX_MODEL_SOURCE_DIR}/${MODEL_FILE}")
        if(EXISTS ${FULL_MODEL_PATH})
            message(STATUS "âœ“ Will install required model: ${MODEL_FILE}")
            list(APPEND MODELS_TO_INSTALL ${FULL_MODEL_PATH})
        else()
            message(WARNING "âœ— Missing required model: ${MODEL_FILE}")
            message(WARNING "  Expected at: ${FULL_MODEL_PATH}")
        endif()
    endforeach()

    # ä»…å®‰è£…æ‰¾åˆ°çš„å¿…éœ€æ¨¡å‹æ–‡ä»¶
    if(MODELS_TO_INSTALL)
        # åªå®‰è£…åˆ°ä¸€ä¸ªä½ç½®ï¼Œé¿å…è·¯å¾„é‡å¤
        install(FILES ${MODELS_TO_INSTALL}
            DESTINATION share/rockx_data
            PERMISSIONS OWNER_READ GROUP_READ WORLD_READ
        )

        list(LENGTH MODELS_TO_INSTALL MODELS_COUNT)
        message(STATUS "Will install ${MODELS_COUNT} model files to: /share/rockx_data")
    else()
        message(FATAL_ERROR "No required model files found!")
    endif()

else()
    message(FATAL_ERROR "RockX models directory not found: ${ROCKX_MODEL_SOURCE_DIR}")
endif()

# # ğŸ†• 16. åˆ›å»ºå¯åŠ¨è„šæœ¬
set(LAUNCH_SCRIPT_CONTENT "#!/bin/bash
# SecureVision Launch Script
export ROCKX_MODEL_PATH=/usr/local/share/rockx_data
export QT_QPA_PLATFORM=linuxfb
export QT_QPA_FONTDIR=/usr/share/fonts

# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
if [ ! -d \"/usr/local/share/rockx_data\" ]; then
    echo \"Warning: RockX model files not found at /usr/local/share/rockx_data\"
    echo \"Looking for alternative locations...\"

    # å°è¯•å…¶ä»–å¯èƒ½çš„ä½ç½®
    if [ -d \"/share/rockx_data\" ]; then
        export ROCKX_MODEL_PATH=/share/rockx_data
        echo \"Using models from /share/rockx_data\"
    else
        echo \"Error: No RockX model files found!\"
        exit 1
    fi
fi

# åˆ›å»ºè¿è¡Œæ—¶æ•°æ®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p \${HOME}/.local/share/SecureVision/database
mkdir -p \${HOME}/.local/share/SecureVision/faces

echo \"Starting SecureVision with model path: \$ROCKX_MODEL_PATH\"
exec /usr/local/bin/SecureVision \"\$@\"
")

# åˆ›å»ºå¯åŠ¨è„šæœ¬æ–‡ä»¶
file(WRITE "${CMAKE_BINARY_DIR}/securevision.sh" "${LAUNCH_SCRIPT_CONTENT}")

# å®‰è£…å¯åŠ¨è„šæœ¬
install(FILES "${CMAKE_BINARY_DIR}/securevision.sh"
    DESTINATION bin
    PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE
    RENAME securevision
)

